# Intraday_trading_1.8.5
一、 系統定位與核心架構
交易程式 1.8.5 版本是一個整合了 PyQt5 圖形介面、多執行緒數據處理 與 Shioaji/Fugle API 串接的進階交易系統。它將交易策略、風險管理、數據分析與即時監控封裝在一個獨立的視窗應用程式中。

二、 核心技術模組
1.  圖形化使用者介面 (GUI)：基於 PyQt5 開發，提供包含「啟動盤中交易」、「即時持倉監控」、「回測分析子選單」及「系統參數設定」等功能模組。

2.  多執行緒運算引擎：利用 threading 與 ThreadPoolExecutor 進行 API 數據抓取與策略計算，確保在高頻盤中環境下 UI 介面依然流暢不卡死

3.  同步訊號派發：透過 SignalDispatcher 類別，將背景運算生成的交易訊號、持倉損益及回測進度即時「拋」回主畫面進行更新。

4.  階相似度演算法：捨棄傳統直線距離，導入 DTW (動態時間規整) 搭配 Pearson 相關係數，精準偵測同族群標的之間的連動性。

三、 核心交易策略邏輯
1.  進場機制 (Entry)：

    支援「漲停觸發」與「拉高觸發」雙重模式。
    
    領漲動態替換：系統每分鐘自動掃描追蹤清單，動態判定最強勢的 Leader 標的。
    
    條件式濾網：包含爆量記憶機制 (自追蹤起曾爆量 1.5 倍)、漲幅範圍 (-1% ~ 6%) 及峰頂不創高判斷。

2.  風險控管 (Risk Management)：

    自動停損佈署：進場瞬間自動發送 TouchPrice 觸價單至永豐金控端。
    
    漲停天花板限制：停損價自動校正，確保不超過「漲停價 - 2 Tick」，防止鎖死無法出場。
    
    強制平倉：支援 13:26 撤單平倉機制及緊急「一鍵全部平倉」按鈕。

四、 數據管理與回測功能
1.  數據持久化：系統自動管理 daily_kline_data.json 及 auto_intraday.json，並具備自動清理幽靈股票的防呆功能。

2.  多維度回測模式：

    (I)    自選進場分析：針對特定族群或全市場進行歷史模擬。
    
    (II)   極大化利潤 (Brute Force)：透過暴力破解尋找最佳的「等待時間」與「持有時間」組合。
    
    (III)  平均過高間隔計算：分析標的突破前高所需的平均時間參數。

五、 技術指標與依賴庫 (Stack)
核心語言：Python 3.10+

數據分析：Pandas, NumPy, SciPy (DTW/Pearson)

交易介面：Shioaji (永豐金 API), TouchPrice

行情來源：Fugle RestClient (富果 API)

介面框架：PyQt5

# 更新日誌
版本跨度：v1.7.21 ➔ v1.8.5
更新重點：全面導入圖形化介面 (GUI)、底層演算法替換 (DTW)、以及核心交易邏輯的深度重構與統一。

一、 架構與使用者介面 (UI/UX) 大躍進
在 v1.7.21 中，系統依賴純文字命令列 (CLI) 與 msvcrt 攔截鍵盤輸入；在 v1.8.5 中，系統全面升級為現代化應用程式。

全新 PyQt5 圖形介面：導入深色化 (Dark Mode) 專業面板，將各大功能（盤中監控、回測、參數設定、處置股查詢）模組化為獨立按鈕。

終端機重導向技術：將原本在命令列的 print 輸出，透過 EmittingStream 與正則表達式完美映射到右側的虛擬終端機，並保留了進場 (綠)、停損 (紅)、觸發 (黃) 的高亮色彩。

非同步進度條 (Progress Bar)：新增回測專用的動態進度條。透過 SignalDispatcher 跨執行緒派發訊號，徹底解決過去大範圍回測時「畫面假死、不知道跑到哪」的問題。

即時持倉監控面板：新增非阻塞式 (Modeless) 的持倉監控表 (QTableWidget)，可隨時查看當前庫存、現價與即時未實現損益。

二、 核心交易邏輯大升級 (The 4 Big Optimizations)
這是本次更新的靈魂，解決了過去版本「防禦過當導致無交易」的問題，大幅提升抓取機會的能力。

全面解放領漲替換 (Dynamic Leader)：打破舊版「誰先觸發誰就是永遠的領漲」的死板限制。現在系統每分鐘會動態掃描追蹤清單，只要有人 rise 突破成為第一，立刻篡位為新 Leader，並重置等待期，精準捕捉族群真正的火車頭。

強者優先放空 (Strongest First)：廢除舊版略顯保守的「中庸選股 (len(eligible)//2)」，改為在符合所有嚴格濾網的條件下，直接放空「反彈漲幅最大」的標的 (eligible[0])，擴大獲利空間。

爆量記憶機制 (Volume Memory)：舊版要求在等待期滿的「當下」必須有量，常導致錯失機會。新版採用 .any() 記憶法，只要自追蹤以來「曾經」爆出 1.5 倍以上的均量，即視為動能有效。

漲幅邊界放寬 (Relaxed Bounds)：將進場的漲幅限制由原先的 0% ~ 6% 放寬至 -1% ~ 6%，將稍微翻黑但連動性極高的優質標的納入打擊範圍。

三、 演算法與相似度過濾進化
引進 DTW (動態時間規整)：捨棄了舊版單純的同座標距離計算，全面引入 fastdtw 與 Pearson 相關係數 (scipy.stats.pearsonr)。即使跟漲股的發動時間比領漲股晚了幾分鐘，只要「波型相似」就能被精準抓出。

方向性初篩效能優化：在計算複雜的 DTW 之前，加入 np.corrcoef < 0 的基礎防護，直接秒殺方向相反的股票，大幅降低盤中與回測的 CPU 運算負載。

真正的「滾動式」過濾：相似度計算不再是等滿時間才算一次，而是在等待期的「每一分鐘」都在即時剔除不合格的股票。

四、 風控機制與程式碼淨化 (Code Refactoring)
實戰與回測 100% 邏輯對齊：徹底修復了舊版中「回測模組」與「實戰模組」在選股和量能計算上分歧的隱患，確保「回測能賺錢的設定，實戰就會照著做」。

Shioaji 斷線重連與當沖防護：優化 safe_place_order 與 safe_add_touch_condition 機制；下單前嚴格檢查合約的 day_trade (當沖) 屬性，避免買到不可當沖的標的導致違約交割。

深度死代碼清除 (Dead Code Removal)：移除了舊版回測中多達百行的「雙重覆寫迴圈」與大量無效的長篇註解，程式碼體積更輕量，直譯執行速度更快。

下一次更新重點：可用瀏覽資料夾方式選擇憑證位置
