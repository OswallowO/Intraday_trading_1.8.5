# 交易程式 - 當沖量化終端

> **版本跨度**：`v1.7.21` ➔ `v1.8.5.4`
> **更新重點**：全面導入現代化圖形介面 (GUI)、底層演算法重構 (0~1 DTW)、核心交易邏輯深度統一、無縫升級機制，以及全新「法人級盤後連動分析模組」。

---

## 一、 架構與使用者介面 (UI/UX) 大躍進
系統正式告別純文字命令列 (CLI) 與鍵盤攔截，全面升級為現代化應用程式！

* **全新 PyQt5 圖形介面**：導入深色化 (Dark Mode) 專業面板，將各大功能（盤中監控、回測、參數設定、處置股查詢）模組化為獨立按鈕。
* **終端機重導向技術**：透過 `EmittingStream` 與正則表達式，完美將終端機輸出映射到介面右側的虛擬終端機，並保留進場 (<span style="color:#2ECC40">綠</span>)、停損 (<span style="color:#FF4136">紅</span>)、觸發 (<span style="color:#FFDC00">黃</span>) 的高亮色彩。
* **非同步進度條 (Progress Bar)**：新增回測專用的動態進度條。透過跨執行緒派發訊號，徹底解決大範圍回測時「畫面假死、失去進度反饋」的問題。
* **即時持倉監控面板**：新增非阻塞式 (Modeless) 的 `QTableWidget` 監控表，可隨時查看當前庫存、現價與即時未實現損益，且不影響主程式操作。
* **憑證載入優化**：(v1.8.5.4 更新) 在「登入/修改帳戶」介面中加入 `📁 瀏覽...` 按鈕，支援直接透過檔案總管選擇 Shioaji 憑證 (.pfx / .p12)，免除手動輸入絕對路徑的困擾。

---

## 二、 核心交易邏輯大升級
解決舊版「防禦過當導致無交易」的痛點，大幅提升抓取機會的能力與風控精準度。

* **全面解放領漲替換 (Dynamic Leader)**：打破舊版「誰先觸發誰就是永遠的領漲」限制。系統每分鐘動態掃描，只要有跟漲股 `rise` 突破第一，立刻篡位為新 Leader 並重置等待期，精準捕捉真正的火車頭。
* **動態防禦型選股 (Mid-Tier Targeting)**：廢除舊版的「強者優先放空」，改為在符合所有嚴格濾網下，執行**「奇數取中位數，偶數取中位數後一位」**的防禦性邏輯。強制避開最強的軋空高風險股，轉而狙擊漲幅中庸、安全性更高的標的。
* **爆量記憶機制 (Volume Memory)**：採用 `.any()` 記憶法，只要自追蹤以來「曾經」爆出 1.5 倍以上的均量即視為動能有效，不再因等待期滿當下量縮而錯失機會。
* **漲幅邊界放寬 (Relaxed Bounds)**：將進場的漲幅限制由 `0% ~ 6%` 放寬至 `-1% ~ 6%`，將稍微翻黑但連動性極高的優質標的納入打擊範圍。
* **無縫升級機制 (Seamless Upgrade)**：(v1.8.5.4 更新) 徹底修復「拉高轉漲停」的時間連續性盲點。當領漲股從「拉高進場」鎖死為「漲停進場」時，系統不再粗暴重置，而是**保留最初的發動起點 (`start_time`) 與追蹤清單**，確保跟漲股前期的連動波型不被抹滅，精準捕捉「前期跟漲，後期力竭」的極品背離空點。

---

## 三、 演算法與相似度過濾進化
* **🌟 導入「0 ~ 1 絕對距離相似度」演算法**
  * **修正痛點**：原 Pearson 相關係數在走勢反向時會產生無意義負值，導致過濾邏輯混亂。
  * **全新機制**：改採 DTW 計算對齊路徑的「平均絕對誤差距離」，並映射至 `0 ~ 1` 的絕對分數。完美賦予 `>= 0.4` 門檻清晰的物理意義（誤差不超過 0.6 個標準差）。
* **斬斷「歷史包袱」，動態時間窗縮距**
  * **修正痛點**：舊系統強制回溯 15 分鐘，導致小弟因「前朝大哥」時期的走勢包袱遭誤判錯殺。
  * **全新機制**：回溯時間窗由 `15 分鐘` 縮減至 `2 分鐘`。確立「換大哥不翻舊帳」邏輯，精準比對新領漲發動當下的連動性，大幅提高小弟存活率。
* **真正的「滾動式」過濾**：相似度計算改為在等待期的「每一分鐘」即時動態剔除不合格股票，確保跟單純度。

---

## 四、 盤後數據與連動分析中心 (New!)
將原「計算平均過高」升級整合為綜合樞紐，正式跨入法人級量化研究領域。

* **[A] 宏觀模式 (全天連動掃描)**：自動抓取各族群當日最高漲幅股為領漲，橫跨 `09:00~13:30` 計算全天候相似度，作為人工族群分類的盤後健檢工具。
* **[B] 微觀模式 (實戰動態模擬)**：內建微型回測引擎，完美重演盤中「發動 ➔ 領漲替換 ➔ 重新等待」的動態生命週期。在等待期滿瞬間「攔截時間窗」，真實還原實戰當下的 DTW 相似度。
* **視覺化結果報表**：掃描完成後，自動彈出深色風格數據表格，直觀呈現：`族群`、`領漲股`、`跟漲股`、`結算時間窗`、`DTW 分數`，並以紅綠色塊標註 `✅ 合格` 或 `❌ 剔除`。
* **CSV 數據匯出**：(v1.8.5.4 更新) 新增將連動分析結果一鍵匯出為 `.csv` 檔案的功能，並預設採用 `utf-8-sig` 編碼，確保以 Excel 開啟時中文不會顯示亂碼，大幅提升研究數據的後續可用性。

---

## 五、 風控機制與系統修復 (Refactoring)
* **實戰與回測 100% 邏輯對齊**：徹底修復舊版「回測」與「實戰」模組在選股與量能計算上分歧的隱患，確保「回測能賺錢的設定，實戰就會照著做」。
* **Shioaji 斷線重連與當沖防護**：優化 API 呼叫機制；下單前嚴格檢查合約的 `day_trade` 屬性，防堵買到不可當沖標的導致違約交割的風險。
* **資料結構與 UI 臭蟲修復**：
  * 修正 `nb_matrix_dict.json` 巢狀結構解析錯誤，並加入處置股過濾，避免盤後分析無效運算。
  * 修正按鈕 Hover 反白失效問題，動態調整撞衫底色的視覺反饋。
  * 全面統一子視窗繼承 `BaseDialog`，確保專業暗黑風格 (Dark Mode) 零死角。
